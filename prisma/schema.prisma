// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Rol {
  ADMIN
  VENTAS
  CLIENTE
}

enum EstadoCotizacion {
  PENDIENTE
  APROBADA
  RECHAZADA
  FACTURADA
}

model Usuario {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String   @unique
  password  String?
  role      Rol
  activo    Boolean  @default(true)
  activationToken String? @unique
  activationExpires DateTime?
  clienteId Int?
  cliente   Cliente?

  cotizaciones Cotizacion[]
  metas        MetaMensual[]

  createdAt DateTime @default(now())
}

model Cliente {
  id        Int      @id @default(autoincrement())
  nombre    String
  documento String?
  telefono  String?
  email    String?
  direccion String?

  usuarioId Int?     @unique
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])

  cotizaciones Cotizacion[]
}

model Producto {
  id                Int      @id @default(autoincrement())
  nombre            String
  precio_material   Float
  precio_mano_obra  Float
  createdAt         DateTime @default(now())

  items CotizacionItem[]
}

model Cotizacion {
  id        Int      @id @default(autoincrement())
  numero    String   @unique
  margen    Float
  total     Float
  estado    EstadoCotizacion @default(PENDIENTE)
  
  createdAt DateTime @default(now())

  clienteId Int
  usuarioId Int

  cliente Cliente @relation(fields: [clienteId], references: [id])
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  items CotizacionItem[]
}

model CotizacionItem {
  id           Int @id @default(autoincrement())
  cotizacionId Int
  productoId   Int
  cantidad     Int
  precio       Float
  subtotal     Float

  cotizacion Cotizacion @relation(fields: [cotizacionId], references: [id])
  producto   Producto   @relation(fields: [productoId], references: [id])
}

model MetaMensual {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  monto     Float
  mes       Int      // 1-12
  anio      Int      // 2025, 2026...
  
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([usuarioId, mes, anio])
  @@index([mes, anio])
}